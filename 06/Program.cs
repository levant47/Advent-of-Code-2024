public static class Program
{
    public static void Main()
    {
        Console.WriteLine("Starting problem 06...");

        var situation = Situation.Parse(INPUT);
        var simulation = Simulation.Make(situation);
        var loops = new HashSet<Position>();
        while (true)
        {
            var loop = simulation.CheckForLoopOpportunities();
            if (loop != null) { loops.Add(loop); }
            if (simulation.Simulate() != SimulateResult.NotFinished) { break; }
        }
        Console.WriteLine($"Part 1 answer: {simulation.VisitedPositions.Select(position => position.JustPosition()).Distinct().Count()}");
        Console.WriteLine($"Part 2 answer: {loops.Count}");

        Console.WriteLine("Done");
    }

    public record Position(int X, int Y)
    {
        public Position Add(Position other) => new(X + other.X, Y + other.Y);

        public DirectedPosition WithDirection(int directionInDegrees) => new(X, Y, directionInDegrees);
    }

    public record DirectedPosition(int X, int Y, int DirectionInDegrees)
    {
        public Position JustPosition() => new(X, Y);
    }

    public enum SimulateResult
    {
        NotFinished,
        LeftMap,
        Looped,
    }

    public static Position GetMovementInDirection(int directionInDegrees) => directionInDegrees switch
    {
        0 => new(0, -1),
        90 => new(1, 0),
        180 => new(0, 1),
        270 => new(-1, 0),
        _ => throw new(),
    };

    public class Simulation
    {
        public Situation Situation;
        public Position GuardPosition;
        public int GuardDirectionInDegrees; // zero is north
        public HashSet<DirectedPosition> VisitedPositions;

        public static Simulation Make(Situation situation) => new()
        {
            Situation = situation,
            GuardPosition = situation.StartingGuardPosition,
            VisitedPositions = [situation.StartingGuardPosition.WithDirection(0)],
        };

        public SimulateResult Simulate()
        {
            var newPosition = GuardPosition.Add(GetMovementInDirection(GuardDirectionInDegrees));
            if (newPosition.X < 0 || newPosition.X >= Situation.MapWidth || newPosition.Y < 0 || newPosition.Y >= Situation.MapHeight)
            {
                return SimulateResult.LeftMap;
            }
            if (VisitedPositions.Contains(newPosition.WithDirection(GuardDirectionInDegrees)))
            {
                return SimulateResult.Looped;
            }
            VisitedPositions.Add(GuardPosition.WithDirection(GuardDirectionInDegrees));
            if (Situation.Obstacles.Contains(newPosition))
            {
                GuardDirectionInDegrees = Degrees(GuardDirectionInDegrees + 90);
                return SimulateResult.NotFinished;
            }
            GuardPosition = newPosition;
            return SimulateResult.NotFinished;
        }

        public Position? CheckForLoopOpportunities()
        {
            var movement = GetMovementInDirection(GuardDirectionInDegrees);
            var newObstacle = GuardPosition.Add(movement);
            if (Situation.Obstacles.Contains(newObstacle) || newObstacle.X < 0 || newObstacle.X >= Situation.MapWidth || newObstacle.Y < 0 || newObstacle.Y >= Situation.MapHeight)
            {
                return null;
            }
            var newSituation = Situation.Copy();
            newSituation.Obstacles.Add(newObstacle);
            var newSimulation = Make(newSituation);
            while (true)
            {
                var simulationResult = newSimulation.Simulate();
                if (simulationResult == SimulateResult.Looped) { return newObstacle; }
                if (simulationResult == SimulateResult.LeftMap) { return null; }
            }
        }
    }

    public class Situation
    {
        public Position StartingGuardPosition;
        public int MapWidth;
        public int MapHeight;
        public HashSet<Position> Obstacles;

        public Situation Copy() => new()
        {
            StartingGuardPosition = StartingGuardPosition,
            MapWidth = MapWidth,
            MapHeight = MapHeight,
            Obstacles = Obstacles.ToHashSet(),
        };

        public static Situation Parse(string source)
        {
            var lines = source.Split('\n').Select(line => line.Trim()).ToList();
            var result = new Situation { Obstacles = [], MapHeight = lines.Count, MapWidth = lines[0].Length };
            for (var y = 0; y < lines.Count; y++)
            {
                var line = lines[y];
                for (var x = 0; x < line.Length; x++)
                {
                    var c = line[x];
                    if (c == '#') { result.Obstacles.Add(new(x, y)); }
                    else if (c == '^') { result.StartingGuardPosition = new(x, y); }
                }
            }
            return result;
        }
    }

    public static int Modulo(int dividend, int divisor)
    {
        if (dividend == 0 || divisor == 0) { return 0; }
        var result = dividend % divisor;
        if (Math.Sign(dividend) != Math.Sign(divisor))
        {
            result += divisor;
        }
        return result;
    }

    public static int Degrees(int value) => Modulo(value, 360);

    public const string EXAMPLE_INPUT = """
    ....#.....
    .........#
    ..........
    ..#.......
    .......#..
    ..........
    .#..^.....
    ........#.
    #.........
    ......#...
    """;

    public const string INPUT = """
    ......#.............#.....................#..#.........................................................#.................#.#......
    .................................#.....#............#........................................#.................................#..
    ..................#.#.....#........#.#...#.....#..............#................#..#....................................#..#.......
    .#....#......................#..........................................................................#......#..................
    ..............#..................#..#............................................#.....#....#.........#...........................
    ..............#.......#...#.....#....................................................................#...................#........
    ....................................................#............#....................................#.............#........#....
    ..........................#....#...................##.............#.#............................................#................
    ...............#.......#..................................................#....#..............#..##.....##.................#......
    ....#............#.......##................#......#.........#.#.......#...#......................#...##...........................
    #.........................................#.......#.....#......................#.........#......#.................................
    .......#.......#........#......#.......................#..........#....#.##.........#......#.....................#.#..............
    ..........#.....................#.................#................................................................#..............
    ...........................................#.................................#............#....................................#..
    .....................#.....#..........#...................................................###........#............................
    .....#.............#....#.................................#.#............##..#......................................#.............
    ........#....#.................#..................#............................#...#.#.............#..............................
    .............................................#.....#.................................#............................................
    ......................#.#...................#...#...........................#....#..#............#................................
    .......#...#.............#................#................#...............................................#...........#..........
    ............#............................#..............................................#......................#................#.
    ......#..............................................#......#.................................#..................................#
    ................#...............................#.....................................................................#......#....
    #....#.............##..................................#.......#..............................#....#..............................
    ...........#..................#.....#...................................#.........#.........................................#.....
    .....#........................#.#.............#.#.......................#........#.....................................#........#.
    ...................................................................................................#..............................
    ......#...........................#...................................................#....................................##...#.
    #..#...............#.....#............................#....................#...................#...............#..................
    .......#.........#......##...........................................#.......................#....................................
    .................................................................................#....................#.........#.................
    ................................#............................................#..............#................................#....
    .............................#.............#.............#....#............#.#......#............#...........................#....
    ....................................#....#...........##..........................................................#................
    .......#.....................................................................................#...............................#....
    .#....#...............#....................#............................#...............#....................#.................#..
    ......................................#.#....#....#.......................................................#...................#...
    ....................#.....#..............................#....................#...........................................#.......
    ...............................................................................................#.........#........................
    .........#............#...........................................................................................................
    ....#..#.....#..................#..........#.........#............##..#...........................................................
    ....#.................................#.........................................................#...#..........#..................
    ...................##.....#.....#.#...#..............................#.........#......#......#............#.......................
    .................#.....#....#..................................................................................#..............#...
    .....#............#........................................................#.........#..............#.......#.....................
    ...........#...........................................................#...#..............................#.............#........#
    ............#....#...............#.....#...................................................................#......................
    ....#........................#..........#.............................#.....#................................#....................
    #............#................#....#..............................................................................................
    .......##..........#................................................................#.........#..............................##...
    ..........#.....................................#.................#.........#................................................#.#..
    ........#....................#...............#.#.................#..#.................#...............#..#.......................#
    ................................#.............................##.........#.......#...........#....................................
    .....#........#....#...............#............##.......................................................#........................
    ...#..............................#........................................................................................#......
    .....#............................................#............#.....#.........#.........................................#........
    ........................................#......................................#.#.......#.................................#.#....
    ..#......#..........................#........................................................................#........#.......#...
    .#.....#.#..#........#.......#....................................................................................................
    ...............................................................#........#...#.....................................................
    ..................#..........#..............................................#..........................#..........................
    ..............................................................#................#......#....................#......................
    ..........##.............#...............................................#...#......#......#.............#........................
    .#......#........#.......................#...................................................................................#....
    .........................#...........................................................................................#.......#....
    .......................................#.................................#......................#........................#..#.#..#
    .............#................................................#................#.....................#...................#......#.
    ...#.....................#.................#.........................................#...#..............................#.........
    ..#....................................#..............#...........#..........................................#....................
    ......#...........................................................................................................................
    ........##............................................#.......................................#.#...#..............##.............
    .........#...#.........#.........#...........#....................................................................................
    .#..#..........................................#.........^..................................#......................#.........#....
    ..........................#..................................................#..............#..#......#....#.....#..........#....#
    .....................................#.......................................................................................#....
    .....#.......#...................#.......#...............................#..#...#...........................................#.....
    .........#.#........................................................#......#.....#................................................
    ..#............#.....#.......#..........................#................................#..........#.............#...............
    ...............................#....#..#...#..#...............#.......................#..........................................#
    .........................................#..............#.............#..........................................#................
    ..........................#..#.........#........................................................................#.................
    .......#.....................................#........................#..#.....#..........#...#.........#.........................
    ............................................................................................#...............................#.....
    ....................................................................................#.............................................
    ........#.................#...................................................................#.......#...........................
    ..#....#......#............#................#.......#...........#......................#..................................##......
    ...............#................................#.........#.............................#.........................#...............
    ...................#...#.......................................................#..#....#......................................#...
    ..........................##.........#..............................#.....##............#.........................................
    ..............................................................................#...#.............................##.#..............
    #..................#..............................#...............................................................................
    .....#..........#.........................................................#.......#...........................##.........#........
    ..##..#..#..........................#...#...#..............................................................#.#....................
    ..#.#.........................#...........#...............................................#...#...........#.......................
    ...............................#......................#......................#.#...............................#..................
    .......#.........................#....#..................................................#............#.#.........................
    .................#.........#.....#.............................................................................#..................
    ............#.....................................................#.#................#......#.....#..................#............
    .#...............#..............................................................................................#................#
    .#....#.................................#..#....#......#...........#..........................................#...................
    #.#.................................................................................................................#.............
    ........#..................#..................................................#................#.#...............#......#.........
    ........#...................#......................#.......#.#...............#....................................................
    .................#.#.........#....#....................#...#........#...#...#.....................................................
    .........................#...............................#............................#.............#.................#...........
    ....#...................................#.#.....................#.............#.........##......#........................#........
    ..................#..#...#........#...#....#........#.............#............#.....#..............#.......................#.....
    ....#....#......#..#.....................................#...#......#.........................................................#..#
    .....................#................#.#..##..............#...................................#...................#.#............
    ...........................##.#...............##...........#.......................................................#............#.
    ................#...................................................................#....#.........#........#..........#..........
    ...#........#...........................#.............#.................##......#.................................................
    ............#............................................#..............#...#...........................#.........................
    .....#...........................#...............#............#...........#.....................................#....#............
    ...#................#.......#.......................#.......................................................#...............#.....
    ..........................................#.....#..#........#..........................................#........................#.
    ........#..................#.........#.....................#....#.......#..................#.............................#......#.
    .........#.#........................................................................#................................#.......#....
    ..........................#.#..........#.........#.........#.......................#.......................................#......
    .........#............................#.............#...#.....#......................#......................................#...#.
    ...#............................#...................#......................................................................#......
    ............................#..........#..#..#....#................#..........#...............#.........#.....#...................
    ##...#.........................#...........#.................#..............................#.....................................
    ....#.................#.......#............#........#.............................................................#.......#......#
    ............................##.#................#................#.#.............................................................#
    .....#.#........................#.............#.................#......#..........#.........................#....................#
    ..........................................#.........................#.........................#.......#..#..........#.............
    ....#.#......#...........................#................#...#.........##...............#..................#.....................
    ...............................................#...#.#...#...#..........#...#........................#......#.....................
    ....#.......#....................#........#........#......#.................##...................#.....#...#.............#........
    """;
}
